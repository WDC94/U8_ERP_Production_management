<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>模具台账登记</title>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { primary: '#0088cc', secondary: '#006400', neutral: '#f9f9f9', 'neutral-dark': '#666666' },
          fontFamily: { sans: ['Arial','sans-serif'] }
        }
      }
    }
  </script>
  <style>
    body { background: #f9f9f9; }
    /* 表单控件统一尺寸与圆角 */
    #mold-period-form input[type="text"],
    #mold-period-form input[type="number"],
    #mold-period-form input[type="date"],
    #mold-period-form select{
      height: 40px;
      padding: 0 12px;
      border-radius: 0.5rem;
      border: 1px solid #d1d5db;
      outline: none;
    }
    #mold-period-form textarea{
      min-height: 64px;
      padding: 10px 12px;
      border-radius: 0.5rem;
      border: 1px solid #d1d5db;
      outline: none;
    }
    #mold-period-form .grid > div { min-width: 260px; }
    .chip{display:inline-flex;align-items:center;border:1px solid #d1d5db;border-radius:9999px;padding:0 10px;margin:4px 6px 0 0;font-size:12px;white-space:nowrap}
    .chip .x{margin-left:8px;cursor:pointer}
    .modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.35)}
    .modal-box{background:#fff;margin:5vh auto;padding:16px;border-radius:12px;max-width:960px}
    .dropdown{position:absolute;z-index:50;background:#fff;border:1px solid #e5e7eb;border-radius:.5rem;box-shadow:0 2px 10px rgba(0,0,0,.08);max-height:240px;overflow:auto;width:100%}
    .dropdown div{padding:8px 10px;cursor:pointer}
    .dropdown div:hover{background:#f3f4f6}
  </style>
</head>

<body class="font-sans text-gray-800">
  <!-- 顶部栏 -->
  <header class="bg-white py-4 shadow-md fixed top-0 left-0 right-0 z-10">
    <div class="max-w-7xl mx-auto px-4 flex justify-between items-center">
      <div class="flex items-center">
        <span class="text-xl font-bold mr-2">澳升泵业</span>
        <span class="text-primary font-semibold">生产管理辅助平台</span>
      </div>
      <div class="flex items-center space-x-4">
        <a href="/user_home.html" class="text-sm text-gray-700 hover:text-primary">主页</a>
        <span class="text-sm text-gray-700">欢迎，<span class="font-semibold">{{ username }}</span></span>
        <button onclick="logout()" class="text-sm text-white bg-primary px-4 py-2 rounded hover:bg-blue-700 transition">退出登录</button>
      </div>
    </div>
  </header>

  <div class="flex pt-20">
    <!-- 侧边菜单 -->
    <aside class="w-60 bg-[#808080] h-screen fixed top-20 left-0 bottom-0 text-white">
      <nav class="flex flex-col py-6 px-4 space-y-3">
        <a href="/user_home.html" class="px-3 py-2 rounded hover:bg-white/10">用户主页</a>
        <a href="/sync_main.html" class="px-3 py-2 rounded hover:bg-white/10">数据同步</a>
        <a href="/mrp_run.html" class="px-3 py-2 rounded hover:bg-white/10">MRP运算</a>
        <a href="/purchase_main.html" class="px-3 py-2 rounded hover:bg-white/10">生成请购单</a>
        <a href="/mold_main.html" class="px-3 py-2 rounded hover:bg-white/10 bg-white/20">模具管理</a>
        <a href="/analysis_report.html" class="px-3 py-2 rounded hover:bg-white/10">数据报表</a>
        <!-- ✅ 新增：数据设置 -->
        <a href="/data_settings.html" class="px-3 py-2 rounded hover:bg-white/10">数据设置</a>
      </nav>
    </aside>

    <!-- 主内容 -->
    <main class="flex-1 max-w-7xl mx-auto px-4 md:px-6 lg:px-8 ml-60 pb-10">
      <!-- 表单 -->
      <section class="bg-white shadow rounded-xl mt-6 p-5">
        <h1 class="text-lg font-bold mb-4">模具台账登记</h1>

        <form id="mold-period-form" class="space-y-6" autocomplete="off">
          <!-- 第一行 -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
            <div>
              <label class="block text-sm font-semibold mb-1">模具产品名称</label>
              <input id="product_name" type="text" class="w-full" placeholder="请输入模具产品名称" required />
            </div>

            <div class="relative">
              <label class="block text-sm font-semibold mb-1">铸造供应商</label>
              <input type="text" id="casting-supplier" class="w-full" placeholder="输入关键字搜索" />
              <input type="hidden" id="casting-supplier-id" />
              <div id="casting-supplier-list" class="dropdown hidden"></div>
            </div>

            <div class="relative">
              <label class="block text-sm font-semibold mb-1">模具供应商</label>
              <input type="text" id="mold-supplier" class="w-full" placeholder="输入关键字搜索" />
              <input type="hidden" id="mold-supplier-id" />
              <div id="mold-supplier-list" class="dropdown hidden"></div>
            </div>
          </div>

          <!-- 第二行 -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
            <div>
              <label class="block text-sm font-semibold mb-1">开模时间</label>
              <input id="start_date" type="date" class="w-full" />
            </div>
            <div>
              <label class="block text-sm font-semibold mb-1">交付时间</label>
              <input id="end_date" type="date" class="w-full" />
            </div>
            <div>
              <label class="block text-sm font-semibold mb-1">金额（元）</label>
              <input id="amount" type="number" step="0.01" class="w-full" placeholder="0.00" />
            </div>
          </div>

          <!-- 第三行 -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
            <div>
              <label class="block text-sm font-semibold mb-1">所属公司</label>
              <select id="company" class="w-full">
                <option value="">请选择</option>
                <option value="浙江南泵">浙江南泵</option>
                <option value="澳升泵业">澳升泵业</option>
                <option value="长帆机械">长帆机械</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-semibold mb-1">模具工艺</label>
              <select id="process_id" class="w-full">
                <option value="">请选择</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-semibold mb-1">模具费是否返还</label>
              <select id="refund_yes_no" class="w-full">
                <option value="否">否</option>
                <option value="是">是</option>
              </select>
            </div>
          </div>

          <!-- 第四行 -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
            <div>
              <label class="block text-sm font-semibold mb-1">模具费返还方式</label>
              <select id="refund_method_id" class="w-full" disabled>
                <option value="">（选择“是否返还”为“是”后可选）</option>
              </select>
            </div>

            <div class="relative">
              <label class="block text-sm font-semibold mb-1">物料编码（可多选）</label>
              <input type="text" id="material-input" class="w-full" placeholder="输入编码或名称搜索后回车添加" />
              <div id="material-list" class="dropdown hidden"></div>
              <div id="material-chips" class="mt-1"></div>
              <div id="material-hint" class="text-xs text-gray-500 mt-1"></div>
            </div>

            <div>
              <label class="block text-sm font-semibold mb-1">备注</label>
              <textarea id="remark" class="w-full" placeholder="可填写补充信息"></textarea>
            </div>
          </div>

          <!-- 附件 -->
          <div>
            <label class="block text-sm font-semibold mb-1">附件</label>
            <div class="flex items-center gap-3">
              <button type="button" id="upload-btn" class="px-3 py-2 rounded bg-gray-100 hover:bg-gray-200">选择文件</button>
              <span class="text-sm text-gray-500">可一次选择多个文件</span>
            </div>
            <input id="file-input" type="file" multiple class="hidden" />
            <div id="file-list" class="mt-2 text-sm"></div>
          </div>

          <div class="flex items-center gap-3">
            <button type="submit" class="px-5 py-2 rounded bg-primary text-white hover:bg-blue-700 transition">保存</button>
            <button type="button" class="px-4 py-2 rounded border" onclick="resetForm()">重置</button>
          </div>
        </form>
      </section>

      <!-- 列表 -->
      <section class="bg-white shadow rounded-xl mt-6 p-5">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-bold">已登记模具台账</h2>
          <div class="flex items-center gap-2">
            <button class="px-3 py-2 text-sm rounded border" onclick="loadList()">刷新</button>
            <!-- ✅ 改为服务端导出，避免 Excel 乱码 -->
            <a class="px-3 py-2 text-sm rounded border bg-gray-50 hover:bg-gray-100" href="/api/mold/period/export/csv">导出 CSV</a>
            <a class="px-3 py-2 text-sm rounded border bg-gray-50 hover:bg-gray-100" href="/api/mold/period/export/xlsx">导出 Excel</a>
          </div>
        </div>
        <div class="overflow-auto">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="bg-gray-50">
                <th class="text-left px-3 py-2">ID</th>
                <th class="text-left px-3 py-2">产品名称</th>
                <th class="text-left px-3 py-2">铸造供应商</th>
                <th class="text-left px-3 py-2">模具供应商</th>
                <th class="text-left px-3 py-2">物料编码</th>
                <th class="text-left px-3 py-2">开模时间</th>
                <th class="text-left px-3 py-2">交付时间</th>
                <th class="text-left px-3 py-2">金额</th>
                <th class="text-left px-3 py-2">是否返还</th>
                <th class="text-left px-3 py-2">返还方式</th>
                <th class="text-left px-3 py-2">工艺</th>
                <th class="text-left px-3 py-2">所属公司</th>
                <th class="text-left px-3 py-2">备注</th>
                <th class="text-left px-3 py-2">操作</th>
              </tr>
            </thead>
            <tbody id="list-body"></tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <!-- 编辑弹窗 -->
  <div id="edit-modal" class="hidden">
    <div class="modal-bg" onclick="closeEdit()"></div>
    <div class="modal-box">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-bold text-lg">编辑模具台账</h3>
        <button class="px-2 py-1 border rounded" onclick="closeEdit()">关闭</button>
      </div>
      <form id="edit-form" class="space-y-4">
        <input type="hidden" id="edit-id" />
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
          <div>
            <label class="block text-sm font-semibold mb-1">模具产品名称</label>
            <input id="edit-product_name" type="text" class="w-full" />
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1">金额（元）</label>
            <input id="edit-amount" type="number" step="0.01" class="w-full" />
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1">所属公司</label>
            <select id="edit-company" class="w-full">
              <option value="">请选择</option>
              <option value="浙江南泵">浙江南泵</option>
              <option value="澳升泵业">澳升泵业</option>
              <option value="长帆机械">长帆机械</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1">开模时间</label>
            <input id="edit-start_date" type="date" class="w-full" />
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1">交付时间</label>
            <input id="edit-end_date" type="date" class="w-full" />
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1">模具工艺</label>
            <select id="edit-process_id" class="w-full">
              <option value="">请选择</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1">模具费是否返还</label>
            <select id="edit-refund_yes_no" class="w-full">
              <option value="否">否</option>
              <option value="是">是</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1">模具费返还方式</label>
            <select id="edit-refund_method_id" class="w-full">
              <option value="">请选择</option>
            </select>
          </div>
          <div class="md:col-span-1 lg:col-span-3">
            <label class="block text-sm font-semibold mb-1">备注</label>
            <textarea id="edit-remark" class="w-full"></textarea>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <button type="button" class="px-5 py-2 rounded bg-primary text-white hover:bg-blue-700 transition" onclick="submitEdit()">保存修改</button>
          <button type="button" class="px-4 py-2 rounded border" onclick="closeEdit()">取消</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ===== 工具 =====
    const debounce = (fn, delay=300) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), delay); } };
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const toast = (msg) => alert(msg);
    function logout(){ location.href='/login.html'; }

    // ===== 字典：返还方式 + 工艺（见后端字典接口） =====
    async function loadDictionaries(){
      try{
        const r = await fetch('/api/mold/dictionary/refund_methods');
        const data = r.ok ? await r.json() : [];
        const sel = $('#refund_method_id'); sel.innerHTML = '<option value="">（选择“是否返还”为“是”后可选）</option>';
        data.forEach(x=> sel.insertAdjacentHTML('beforeend', `<option value="${x.id}">${x.name||''}</option>`));
        const esel = $('#edit-refund_method_id'); esel.innerHTML = '<option value="">请选择</option>';
        data.forEach(x=> esel.insertAdjacentHTML('beforeend', `<option value="${x.id}">${x.name||''}</option>`));
      }catch(e){ console.error(e); }

      try{
        const r = await fetch('/api/mold/dictionary/process_methods');
        const data = r.ok ? await r.json() : [];
        const sel = $('#process_id'); sel.innerHTML = '<option value="">请选择</option>';
        data.forEach(x=> sel.insertAdjacentHTML('beforeend', `<option value="${x.id}">${x.name||''}</option>`));
        const esel = $('#edit-process_id'); esel.innerHTML = '<option value="">请选择</option>';
        data.forEach(x=> esel.insertAdjacentHTML('beforeend', `<option value="${x.id}">${x.name||''}</option>`));
      }catch(e){ console.error(e); }
    }

    // ===== “是否返还”联动 =====
    function bindRefundToggle(){
      const yesNo = $('#refund_yes_no');
      const sel = $('#refund_method_id');
      const update = ()=>{
        const enable = yesNo.value==='是';
        sel.disabled = !enable;
        if(!enable) sel.value='';
      };
      yesNo.addEventListener('change', update);
      update();
    }
    function bindEditRefundToggle(){
      const yesNo = $('#edit-refund_yes_no');
      const sel = $('#edit-refund_method_id');
      const update = ()=>{
        const enable = yesNo.value==='是';
        sel.disabled = !enable;
        if(!enable) sel.value='';
      };
      yesNo.addEventListener('change', update);
      update();
    }

    // ===== 供应商模糊搜索 =====
    function bindSupplierSearch({inputId, hiddenId, listId}){
      const ipt = $(inputId), list = $(listId);
      const onInput = debounce(async ()=>{
        const kw = ipt.value.trim();
        if(!kw){ list.classList.add('hidden'); list.innerHTML=''; return; }
        const r = await fetch('/api/mold/supplier/search?kw='+encodeURIComponent(kw));
        const data = await r.json();
        if(!Array.isArray(data) || !data.length){ list.classList.add('hidden'); list.innerHTML=''; return; }
        list.innerHTML = data.slice(0, 50).map(x=> `<div data-id="${x.id}" data-name="${x.supplier_name}">${x.supplier_name}</div>`).join('');
        list.classList.remove('hidden');
      }, 300);
      ipt.addEventListener('input', onInput);
      ipt.addEventListener('focus', onInput);
      list.addEventListener('click', e=>{
        const div = e.target.closest('div[data-id]');
        if(!div) return;
        ipt.value = div.getAttribute('data-name');
        $(hiddenId).value = div.getAttribute('data-id');
        list.classList.add('hidden');
      });
      document.addEventListener('click', e=>{
        if(!list.contains(e.target) && e.target!==ipt) list.classList.add('hidden');
      });
    }

    // ===== 物料模糊搜索 + 多选 chips =====
    const materialSet = new Set();
    let invAbort;
    const matHint = $('#material-hint');

    function renderMaterials(){
      const wrap = $('#material-chips');
      const frag = document.createDocumentFragment();
      materialSet.forEach(code=>{
        const el = document.createElement('span');
        el.className='chip';
        el.innerHTML = `${code}<span class="x" title="移除" data-code="${code}">✕</span>`;
        frag.appendChild(el);
      });
      wrap.innerHTML = '';
      wrap.appendChild(frag);
      wrap.onclick = (e)=>{
        const x = e.target.closest('.x');
        if(x){ materialSet.delete(x.dataset.code); renderMaterials(); updateMatHint(); }
      };
    }
    function updateMatHint(){ matHint.textContent = materialSet.size ? `已选择 ${materialSet.size} 个物料` : ''; }

    function bindInventorySearch(){
      const ipt = $('#material-input'), list = $('#material-list');
      const doSearch = debounce(async ()=>{
        const kw = ipt.value.trim();
        if(!kw){ list.classList.add('hidden'); list.innerHTML=''; return; }
        if(invAbort) invAbort.abort();
        invAbort = new AbortController();
        try{
          const r = await fetch('/api/mold/inventory/search?kw='+encodeURIComponent(kw), {signal: invAbort.signal});
          const data = await r.json();
          if(!Array.isArray(data) || !data.length){ list.classList.add('hidden'); list.innerHTML=''; return; }
          list.innerHTML = data.slice(0, 100).map(x=> `<div data-code="${x.cInvCode}" title="${x.cInvName||''}">${x.cInvCode} ${x.cInvName||''}</div>`).join('');
          list.classList.remove('hidden');
        }catch(e){ if(e.name!=='AbortError'){ console.error(e); } }
      }, 250);
      ipt.addEventListener('input', doSearch);
      ipt.addEventListener('keydown', e=>{
        if(e.key==='Enter'){
          e.preventDefault();
          const v = ipt.value.trim();
          if(v){ materialSet.add(v); renderMaterials(); updateMatHint(); ipt.value=''; list.classList.add('hidden'); }
        }
      });
      list.addEventListener('click', e=>{
        const div = e.target.closest('div[data-code]');
        if(!div) return;
        materialSet.add(div.getAttribute('data-code'));
        renderMaterials(); updateMatHint(); ipt.value=''; list.classList.add('hidden');
      });
      document.addEventListener('click', e=>{
        if(!list.contains(e.target) && e.target!==ipt) list.classList.add('hidden');
      });
    }

    // ===== 附件选择 =====
    let fileList = [];
    const fileInput = $('#file-input'), fileListDiv = $('#file-list');
    $('#upload-btn').addEventListener('click', ()=>{ fileInput.value=""; fileInput.click(); });
    fileInput.addEventListener('change', function(){
      for(const f of this.files){
        const i = fileList.findIndex(x=> x.name===f.name && x.size===f.size);
        i>=0? fileList[i]=f: fileList.push(f);
      }
      renderFileList();
    });
    function renderFileList(){
      if(fileList.length===0){ fileListDiv.innerHTML=""; return; }
      let html='<div class="text-sm mb-1">已选择附件：</div><ul class="list-disc pl-5">';
      fileList.forEach((f,i)=> html+=`<li>${f.name} <span class="text-blue-600 cursor-pointer" onclick="removeFile(${i})">移除</span></li>`);
      html+='</ul>'; fileListDiv.innerHTML=html;
    }
    window.removeFile = (i)=>{ fileList.splice(i,1); renderFileList(); }

    // ===== 提交新增 =====
    $('#mold-period-form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const fd = new FormData();
      const product_name = $('#product_name').value.trim();
      const casting_supplier_id = $('#casting-supplier-id').value.trim();
      const mold_supplier_id = $('#mold-supplier-id').value.trim();
      const start_date = $('#start_date').value || '';
      const end_date = $('#end_date').value || '';
      const amount = $('#amount').value || '';
      const company = $('#company').value || '';
      const process_id = $('#process_id').value || '';
      const remark = $('#remark').value.trim();

      if(!product_name){ toast('请填写模具产品名称'); return; }
      if(!casting_supplier_id){ toast('请选择铸造供应商'); return; }
      if(!mold_supplier_id){ toast('请选择模具供应商'); return; }

      fd.append('product_name', product_name);
      fd.append('casting_supplier_id', casting_supplier_id);
      fd.append('mold_supplier_id', mold_supplier_id);
      if(amount) fd.append('amount', amount);
      if(start_date) fd.append('start_date', start_date);
      if(end_date) fd.append('end_date', end_date);
      if(company) fd.append('company', company);
      if(process_id) fd.append('process_id', process_id);
      if(remark) fd.append('remark', remark);

      if($('#refund_yes_no').value === '是'){
        const refund_method_id = $('#refund_method_id').value || '';
        if(refund_method_id) fd.append('refund_method_id', refund_method_id);
      }

      const arr = Array.from(materialSet);
      if(arr.length) fd.append('material_codes', JSON.stringify(arr));

      fileList.forEach(f=> fd.append('attachments', f, f.name));

      const r = await fetch('/api/mold/period', { method:'POST', body: fd });
      const data = await r.json();
      if(!data || data.success===false){ toast(data?.msg || '保存失败'); return; }
      toast('保存成功');
      resetForm();
      loadList();
    });

    function resetForm(){
      $('#product_name').value='';
      $('#casting-supplier').value=''; $('#casting-supplier-id').value='';
      $('#mold-supplier').value=''; $('#mold-supplier-id').value='';
      $('#start_date').value=''; $('#end_date').value='';
      $('#amount').value=''; $('#company').value=''; $('#process_id').value='';
      $('#refund_yes_no').value='否'; $('#refund_method_id').value=''; $('#refund_method_id').disabled=true;
      $('#remark').value='';
      materialSet.clear(); renderMaterials(); updateMatHint();
      fileList = []; renderFileList();
    }

    // ===== 列表 =====
    let cachedRows = [];
    async function loadList(){
      const r = await fetch('/api/mold/period/list');
      const json = await r.json();
      const rows = json?.data || [];
      cachedRows = rows;
      const tb = $('#list-body'); tb.innerHTML='';
      const frag = document.createDocumentFragment();
      for(const x of rows){
        const refund = (x.refund||'').trim();
        const isRefund = refund ? '是' : '否';
        const tr = document.createElement('tr');
        tr.className='border-b';
        tr.innerHTML = `
          <td class="px-3 py-2">${x.mold_id||''}</td>
          <td class="px-3 py-2">${x.product_name||''}</td>
          <td class="px-3 py-2">${x.casting_supplier||''}</td>
          <td class="px-3 py-2">${x.mold_supplier||''}</td>
          <td class="px-3 py-2">${x.materials||''}</td>
          <td class="px-3 py-2">${x.start_date||''}</td>
          <td class="px-3 py-2">${x.end_date||''}</td>
          <td class="px-3 py-2">${x.amount??''}</td>
          <td class="px-3 py-2">${isRefund}</td>
          <td class="px-3 py-2">${refund||''}</td>
          <td class="px-3 py-2">${x.process||''}</td>
          <td class="px-3 py-2">${x.company||''}</td>
          <td class="px-3 py-2">${x.remark||''}</td>
          <td class="px-3 py-2 whitespace-nowrap">
            <button class="text-blue-600 mr-3" onclick="openEdit(${x.mold_id})">编辑</button>
            <button class="text-red-600 mr-3" onclick="delRow(${x.mold_id})">删除</button>
            <button class="text-green-700" onclick="downloadAttachments(${x.mold_id}, this)">下载附件</button>
          </td>`;
        frag.appendChild(tr);
      }
      tb.appendChild(frag);
    }

    async function delRow(id){
      if(!confirm('确认删除该台账？（存在调拨记录将无法删除）')) return;
      const r = await fetch('/api/mold/period/delete/'+id, {method:'POST'});
      const data = await r.json();
      if(data?.success){ toast('删除成功'); loadList(); }
      else toast(data?.msg || '删除失败');
    }

    // ===== 下载附件 =====
    async function downloadAttachments(moldId, btn){
      try{
        btn.disabled = true;
        const r = await fetch('/api/mold/period/'+moldId);
        if(!r.ok){ toast('获取附件失败'); return; }
        const d = await r.json();
        const attachments = Array.isArray(d.attachments) ? d.attachments : [];
        if(!attachments.length){ toast('无附件'); return; }
        for(const f of attachments){
          const a = document.createElement('a');
          a.href = `/api/mold/attachment/download/${f.id}`;
          a.download = f.file_name || '';
          document.body.appendChild(a);
          a.click();
          a.remove();
        }
      }catch(e){
        console.error(e); toast('下载失败');
      }finally{
        btn.disabled = false;
      }
    }
    window.downloadAttachments = downloadAttachments;

    // ===== 编辑 =====
    async function openEdit(id){
      const r = await fetch('/api/mold/period/'+id);
      if(!r.ok){ toast('获取详情失败'); return; }
      const d = await r.json();
      $('#edit-id').value = d.mold_id;
      $('#edit-product_name').value = d.product_name||'';
      $('#edit-amount').value = d.amount??'';
      $('#edit-company').value = d.company||'';
      $('#edit-start_date').value = (d.start_date||'').substring(0,10);
      $('#edit-end_date').value = (d.end_date||'').substring(0,10);
      $('#edit-remark').value = d.remark||'';
      $('#edit-process_id').value = d.process_id||'';

      const hasRefund = !!(d.refund_method_id || (d.refund_method_name||'').trim() || (d.refund||'').trim());
      $('#edit-refund_yes_no').value = hasRefund ? '是' : '否';
      $('#edit-refund_method_id').value = d.refund_method_id || '';
      bindEditRefundToggle();

      $('#edit-modal').classList.remove('hidden');
    }
    function closeEdit(){ $('#edit-modal').classList.add('hidden'); }

    async function submitEdit(){
      const id = $('#edit-id').value;
      const payload = {
        product_name: $('#edit-product_name').value.trim(),
        amount: $('#edit-amount').value || null,
        company: $('#edit-company').value || null,
        start_date: $('#edit-start_date').value || null,
        end_date: $('#edit-end_date').value || null,
        remark: $('#edit-remark').value.trim(),
        process_id: $('#edit-process_id').value || null
      };
      if($('#edit-refund_yes_no').value === '是'){
        payload.refund_method_id = $('#edit-refund_method_id').value ? parseInt($('#edit-refund_method_id').value,10) : null;
      }else{
        payload.refund_method_id = null;
      }

      try{
        const r = await fetch('/api/mold/period/'+id, {
          method:'PUT',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        if(!r.ok){
          // 兼容旧接口(若有)可在此补偿
        }
        toast('修改成功');
        closeEdit();
        loadList();
      }catch(e){
        console.error(e); toast('修改失败');
      }
    }

    // ===== 初始化 =====
    (function init(){
      loadDictionaries();
      bindRefundToggle();
      bindSupplierSearch({inputId:'#casting-supplier', hiddenId:'#casting-supplier-id', listId:'#casting-supplier-list'});
      bindSupplierSearch({inputId:'#mold-supplier', hiddenId:'#mold-supplier-id', listId:'#mold-supplier-list'});
      bindInventorySearch();
      loadList();
    })();
  </script>
</body>
</html>
