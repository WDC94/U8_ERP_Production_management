<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>数据同步 - 澳升泵业平台</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#0088cc',
            secondary: '#006400',
            neutral: '#f9f9f9',
            'neutral-dark': '#666666',
          },
          fontFamily: {
            sans: ['Arial', 'sans-serif'],
          },
        },
      }
    }
  </script>
</head>
<body class="bg-neutral min-h-screen text-gray-800 font-sans">

  <!-- 顶部导航栏 -->
  <header class="bg-white py-4 shadow-md fixed top-0 left-0 right-0 z-10">
    <div class="max-w-7xl mx-auto px-4 flex justify-between items-center">
      <div class="flex items-center">
        <span class="text-secondary text-2xl font-bold mr-2">澳升泵业</span>
        <span class="text-primary text-lg font-semibold">生产管理辅助平台</span>
      </div>
      <div class="flex items-center space-x-4">
        <span class="text-sm text-gray-700">欢迎，<span class="font-semibold">{{ username }}</span></span>
        <button onclick="logout()" class="text-sm text-white bg-primary px-4 py-2 rounded hover:bg-blue-700 transition">
          <i class="fa fa-sign-out-alt mr-1"></i> 退出登录
        </button>
      </div>
    </div>
  </header>

  <!-- 主体布局 -->
  <div class="flex pt-20">
    <!-- 左侧菜单栏 -->
    <aside class="w-60 bg-[#808080] h-screen fixed top-20 left-0 bottom-0 z-0 text-white">
      <nav class="flex flex-col py-6 px-4 space-y-3">
        <a href="/user_home.html" class="flex items-center px-3 py-2 rounded hover:bg-gray-700 transition">
          <i class="fa fa-home mr-2"></i> 主页
        </a>
        <a href="/sync_main.html" class="flex items-center px-3 py-2 rounded bg-gray-700">
          <i class="fa fa-sync-alt mr-2"></i> 数据同步
        </a>
        <a href="/mrp_run.html" class="flex items-center px-3 py-2 rounded hover:bg-gray-700 transition">
          <i class="fa fa-cogs mr-2"></i> MRP运算
        </a>
        <a href="/purchase_main.html" class="flex items-center px-3 py-2 rounded hover:bg-gray-700 transition">
          <i class="fa fa-file-alt mr-2"></i> 生成请购单
        </a>
        <a href="/mold_main.html" class="flex items-center px-3 py-2 rounded hover:bg-gray-700 transition">
          <i class="fa fa-tools mr-2"></i> 模具管理
        </a>
        <a href="/analysis_report.html" class="flex items-center px-3 py-2 rounded hover:bg-gray-700 transition">
          <i class="fa fa-chart-line mr-2"></i> 数据报表
        </a>
      </nav>
    </aside>

    <!-- 中间业务区域 -->
    <main class="ml-60 flex-1 p-6">
      <h2 class="text-2xl font-bold mb-6">U8主数据同步</h2>

      <!-- 日期选择 -->
      <div class="flex items-center space-x-4 mb-6">
        <label class="font-medium text-gray-700">同步日期范围：</label>
        <input id="start-date" type="date" class="border rounded px-2 py-1" />
        <span class="text-gray-500">-</span>
        <input id="end-date" type="date" class="border rounded px-2 py-1" />
        <button onclick="setToday()" class="text-sm px-2 py-1 bg-gray-100 rounded hover:bg-gray-200 transition">今天</button>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        <button id="btn-inventory" class="bg-white p-6 rounded-xl shadow hover:shadow-lg transition flex items-center space-x-4"
                onclick="sync('inventory', this)">
          <i class="fa fa-box fa-lg text-primary"></i>
          <span class="text-lg font-medium">同步物料档案</span>
        </button>

        <button id="btn-bom" class="bg-white p-6 rounded-xl shadow hover:shadow-lg transition flex items-center space-x-4"
                onclick="sync('bom', this)">
          <i class="fa fa-sitemap fa-lg text-primary"></i>
          <span class="text-lg font-medium">同步BOM结构</span>
        </button>

        <button id="btn-supplier" class="bg-white p-6 rounded-xl shadow hover:shadow-lg transition flex items-center space-x-4"
                onclick="sync('supplier', this)">
          <i class="fa fa-industry fa-lg text-primary"></i>
          <span class="text-lg font-medium">同步供应商</span>
        </button>

        <button id="btn-mom_order" class="bg-white p-6 rounded-xl shadow hover:shadow-lg transition flex items-center space-x-4"
                onclick="sync('mom_order', this)">
          <i class="fa fa-file-alt fa-lg text-primary"></i>
          <span class="text-lg font-medium">同步生产订单</span>
        </button>

        <button id="btn-prospect_stock" class="bg-white p-6 rounded-xl shadow hover:shadow-lg transition flex items-center space-x-4"
                onclick="sync('prospect_stock', this)">
          <i class="fa fa-warehouse fa-lg text-primary"></i>
          <span class="text-lg font-medium">同步库存展望</span>
        </button>

        <button id="btn-all" class="bg-primary text-white p-6 rounded-xl shadow hover:shadow-lg transition flex items-center space-x-4 justify-center"
                onclick="sync('all', this)">
          <i class="fa fa-sync-alt fa-lg"></i>
          <span class="text-lg font-semibold">一键全部同步</span>
        </button>
      </div>

      <!-- 同步状态 -->
      <div id="sync-status" class="mt-8 text-gray-700 text-sm"></div>
    </main>
  </div>

  <script>
    function logout() {
      alert('您已退出登录');
      window.location.href = '/login';
    }

    // 默认设置今天日期
    function setToday() {
      const today = new Date().toISOString().slice(0, 10);
      document.getElementById('start-date').value = today;
      document.getElementById('end-date').value = today;
    }
    setToday();

    // type与接口映射
    const apiMap = {
      'inventory': '/api/sync/inventory',
      'bom': '/api/sync/bom',
      'supplier': '/api/sync/supplier',
      'mom_order': '/api/sync/mom_order',
      'prospect_stock': '/api/sync/prospect_stock',
      'all': '/api/sync/all'
    };

    function sync(type, btn) {
      const statusDiv = document.getElementById('sync-status');
      const start = document.getElementById('start-date').value;
      const end = document.getElementById('end-date').value;
      if (!start || !end) {
        statusDiv.innerHTML = `<span class="text-red-500"><i class="fa fa-times-circle mr-1"></i>请选择同步日期范围！</span>`;
        return;
      }
      btn.disabled = true;
      btn.classList.add('opacity-50', 'cursor-not-allowed');
      statusDiv.innerHTML = `<i class="fa fa-spinner fa-spin text-primary mr-2"></i>正在同步：${btn.innerText} ...`;

      fetch(apiMap[type], {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({start_date: start, end_date: end})
      })
      .then(res => res.json())
      .then(data => {
        if (data.code === 0) {
          statusDiv.innerHTML = `<span class="text-green-600"><i class="fa fa-check-circle mr-1"></i>${data.msg}</span>`;
        } else {
          statusDiv.innerHTML = `<span class="text-red-500"><i class="fa fa-times-circle mr-1"></i>同步失败：${data.msg}</span>`;
        }
      })
      .catch(e => {
        statusDiv.innerHTML = `<span class="text-red-500"><i class="fa fa-times-circle mr-1"></i>请求出错：${e}</span>`;
      })
      .finally(() => {
        btn.disabled = false;
        btn.classList.remove('opacity-50', 'cursor-not-allowed');
      });
    }
  </script>
</body>
</html>
